<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>èªªé»å…”èµ¤-ä¾†éƒ½ä¾†äº†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    background: #f0f0f0;
    font-family: "Noto Sans TC", sans-serif;
  }

  /* å¤œé–“æ¨¡å¼ï¼ˆåªå½±éŸ¿èƒŒæ™¯/æ§åˆ¶åˆ—ï¼Œä¸æ”¹ PDF ç•«é¢æœ¬èº«ï¼‰ */
  body.dark { background: #111; }
  body.dark #progressBar { background: #555; }
  body.dark #progressValue { background: #00d2ff; }
  body.dark .control-btn {
    background: rgba(60, 60, 60, 0.72);
    color: #fff;
  }
  body.dark #loading { color: #bbb; }

  .book {
    width: 100vw;
    height: 100vh;
    position: relative;
    perspective: 2000px;
    overflow: hidden;
  }

  /* å…±é€šé é¢ */
  .page {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0; left: 0;
    box-sizing: border-box;
    background: #fff;
    transform-origin: left center;
    transition: transform 0.6s ease;
    box-shadow: 0 0 15px rgba(0,0,0,0.25);
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .page.flipped {
    transform: rotateY(-180deg);
    z-index: 1 !important;
  }

  /* å°é¢ï¼šæ»¿ç‰ˆ */
  .cover { padding: 0 !important; background: #000; }
  .cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* PDF canvasï¼šRWD ç¸®æ”¾åˆ°è¦–çª—å…§ä¿æŒæ¯”ä¾‹ */
  .pdf-canvas {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    display: block;
  }

  /* é€²åº¦æ¢ */
  #progressBar {
    position: absolute;
    top: 0; left: 0;
    height: 5px;
    width: 100%;
    background: #ccc;
    z-index: 999;
  }
  #progressValue {
    height: 100%;
    width: 0%;
    background: #4aa3ff;
    transition: width 0.25s ease;
  }

  /* æ§åˆ¶æŒ‰éˆ•ï¼ˆå³ä¸Šè§’ï¼‰ */
  .controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 10px;
    z-index: 999;
  }
  .control-btn {
    background: rgba(255,255,255,0.72);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    user-select: none;
    backdrop-filter: blur(4px);
    -webkit-tap-highlight-color: transparent;
  }
  .control-btn:active { transform: scale(0.98); }

  /* è¼‰å…¥ä¸­æç¤º */
  #loading {
    position: absolute;
    inset: 0;
    display: none;
    justify-content: center;
    align-items: center;
    font-size: 16px;
    color: #666;
    z-index: 998;
    pointer-events: none;
  }

  /* 18+ å½ˆçª— */
  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 5000;
    padding: 20px;
  }
  .modal {
    width: min(420px, 100%);
    background: rgba(255,255,255,0.92);
    border-radius: 16px;
    padding: 18px 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    backdrop-filter: blur(8px);
  }
  body.dark .modal { background: rgba(40,40,40,0.92); color: #fff; }
  .modal h3 { margin: 0 0 8px; font-size: 18px; }
  .modal p { margin: 0 0 14px; font-size: 14px; line-height: 1.6; opacity: 0.9; }
  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  .btn {
    border: 0;
    padding: 10px 12px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    user-select: none;
  }
  .btn-yes { background: #4aa3ff; color: #fff; }
  .btn-no { background: rgba(0,0,0,0.08); }
  body.dark .btn-no { background: rgba(255,255,255,0.12); color: #fff; }

  /* æœªæ»¿ 18 æ‹’çµ•ç•«é¢ */
  .blocked {
    position: absolute;
    inset: 0;
    z-index: 4000;
    display: none;
    justify-content: center;
    align-items: center;
    background: #111;
    color: #fff;
    text-align: center;
    padding: 20px;
  }
  .blocked .box {
    max-width: 520px;
    background: rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 18px 16px;
    line-height: 1.7;
  }
</style>
</head>

<body>
  <!-- é€²åº¦æ¢ -->
  <div id="progressBar"><div id="progressValue"></div></div>

  <!-- æ§åˆ¶ -->
  <div class="controls">
    <div class="control-btn" id="zoomOut">Aâ€“</div>
    <div class="control-btn" id="zoomIn">A+</div>
    <div class="control-btn" id="modeToggle">ğŸŒ™</div>
  </div>

  <div class="book" id="book"></div>
  <div id="loading">PDF é‡æ–°æ¸²æŸ“ä¸­â€¦</div>

  <!-- 18+ Modalï¼ˆå‹•æ…‹æ’å…¥/ç§»é™¤ï¼‰ -->
  <div id="ageModalRoot"></div>

  <!-- æœªæ»¿ 18 æ‹’çµ•ç•«é¢ -->
  <div class="blocked" id="blocked">
    <div class="box">
      <div style="font-size:18px; margin-bottom:6px;">ç„¡æ³•é€²å…¥</div>
      <div style="opacity:.9; font-size:14px;">
        æœ¬å…§å®¹åƒ…é™å¹´æ»¿ 18 æ­²è€…ç€è¦½ã€‚<br>
        è‹¥ä½ å·²å¹´æ»¿ 18 æ­²ï¼Œè«‹é‡æ–°æ•´ç†ä¸¦é¸æ“‡ã€ŒYesã€ã€‚
      </div>
    </div>
  </div>

  <!-- PDF.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
  // ====== è¨­å®šå€ ======
  const PDF_URL = "book.pdf";
  const COVER_URL = "cover.png";

  // PDF æ¸²æŸ“å€ç‡ï¼ˆA+/A- æœƒæ”¹é€™å€‹ï¼‰
  let renderScale = 1.6;
  const SCALE_MIN = 0.8;
  const SCALE_MAX = 2.6;
  const SCALE_STEP = 0.2;

  // ====== ç‹€æ…‹ ======
  const book = document.getElementById("book");
  const loading = document.getElementById("loading");
  const blocked = document.getElementById("blocked");

  let pdfDoc = null;
  let currentPage = 0;         // 0=å°é¢ï¼Œ1..N=PDFé ï¼ˆåŠ ä¸Šå°é¢å¾Œçš„é åºï¼‰
  let isRendering = false;
  let allowed = false;

  // ====== å·¥å…· ======
  function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

  function showLoading(show) {
    loading.style.display = show ? "flex" : "none";
  }

  function updateProgress() {
    const pages = document.querySelectorAll(".page");
    const totalWithoutCover = Math.max(1, pages.length - 1);
    const percent = (currentPage / totalWithoutCover) * 100;
    document.getElementById("progressValue").style.width = clamp(percent, 0, 100) + "%";
  }

  // ====== 18+ Modal ======
  function showAgeModal() {
    const root = document.getElementById("ageModalRoot");
    root.innerHTML = `
      <div class="modal-backdrop" id="ageBackdrop">
        <div class="modal" role="dialog" aria-modal="true">
          <h3>å…§å®¹å¹´é½¡ç¢ºèª</h3>
          <p>è«‹ç¢ºèªä½ æ˜¯å¦å·²å¹´æ»¿ <b>18 æ­²</b>ã€‚</p>
          <div class="modal-actions">
            <button class="btn btn-no" id="ageNo">No</button>
            <button class="btn btn-yes" id="ageYes">Yes</button>
          </div>
        </div>
      </div>
    `;

    document.getElementById("ageYes").onclick = () => {
      localStorage.setItem("age_verified_18", "yes");
      root.innerHTML = "";
      allowed = true;
      initApp(); // é–‹å§‹è¼‰å…¥ PDF
    };

    document.getElementById("ageNo").onclick = () => {
      root.innerHTML = "";
      allowed = false;
      // é–ä½å…§å®¹
      blocked.style.display = "flex";
    };
  }

  function checkAgeGate() {
    const v = localStorage.getItem("age_verified_18");
    if (v === "yes") {
      allowed = true;
      initApp();
    } else {
      showAgeModal();
    }
  }

  // ====== PDF.js åˆå§‹åŒ– ======
  async function loadPDF() {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    pdfDoc = await pdfjsLib.getDocument(PDF_URL).promise;
  }

  function addCover() {
    const cover = document.createElement("div");
    cover.className = "page cover";
    cover.style.zIndex = 999999;
    cover.innerHTML = `<img src="${COVER_URL}" alt="å°é¢">`;
    book.appendChild(cover);
  }

  async function renderAllPdfPages() {
    // æ¸…æ‰èˆŠé ï¼ˆä¿ç•™å®¹å™¨ bookï¼Œæ•´å€‹é‡å»ºæœ€ç°¡å–® & ä¸æ˜“éŒ¯ï¼‰
    book.innerHTML = "";
    addCover();

    // PDF é ï¼šä¾åºæ¸²æŸ“
    for (let i = 1; i <= pdfDoc.numPages; i++) {
      const pdfPage = await pdfDoc.getPage(i);
      const viewport = pdfPage.getViewport({ scale: renderScale });

      const canvas = document.createElement("canvas");
      canvas.className = "pdf-canvas";
      const ctx = canvas.getContext("2d");

      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      await pdfPage.render({ canvasContext: ctx, viewport }).promise;

      const wrapper = document.createElement("div");
      wrapper.className = "page";
      // z-indexï¼šå°é¢åœ¨æœ€ä¸Šé¢ï¼Œå…¶ä»–ç”±å‰åˆ°å¾Œéæ¸›
      wrapper.style.zIndex = (pdfDoc.numPages - i + 1);
      wrapper.appendChild(canvas);

      book.appendChild(wrapper);
    }
  }

  function restoreFlipStateAfterRerender() {
    const pages = document.querySelectorAll(".page");
    // currentPage æŒ‡çš„æ˜¯ã€ŒåŒ…å«å°é¢ã€çš„ç´¢å¼•
    for (let i = 0; i < pages.length; i++) {
      if (i < currentPage) pages[i].classList.add("flipped");
      else pages[i].classList.remove("flipped");
    }
    updateProgress();
  }

  async function rerenderPdfKeepingPosition() {
    if (isRendering) return;
    isRendering = true;
    showLoading(true);

    try {
      await renderAllPdfPages();
      restoreFlipStateAfterRerender();
    } finally {
      showLoading(false);
      isRendering = false;
    }
  }

  // ====== ç¿»é æ‰‹å‹¢ ======
  function attachFlipEvents() {
    let startX = 0;

    document.addEventListener("touchstart", e => {
      if (!allowed) return;
      startX = e.touches[0].clientX;
    }, { passive: true });

    document.addEventListener("touchend", e => {
      if (!allowed) return;
      const endX = e.changedTouches[0].clientX;
      const diff = endX - startX;
      const pages = document.querySelectorAll(".page");

      if (Math.abs(diff) < 40) return;

      // å·¦æ»‘ä¸‹ä¸€é 
      if (diff < 0 && currentPage < pages.length - 1) {
        pages[currentPage].classList.add("flipped");
        currentPage++;
        updateProgress();
      }
      // å³æ»‘ä¸Šä¸€é 
      else if (diff > 0 && currentPage > 0) {
        currentPage--;
        pages[currentPage].classList.remove("flipped");
        updateProgress();
      }
    }, { passive: true });
  }

  // ====== æ§åˆ¶æŒ‰éˆ• ======
  document.getElementById("modeToggle").onclick = () => {
    document.body.classList.toggle("dark");
    document.getElementById("modeToggle").textContent =
      document.body.classList.contains("dark") ? "â˜€ï¸" : "ğŸŒ™";
  };

  document.getElementById("zoomIn").onclick = async () => {
    if (!allowed || isRendering) return;
    renderScale = clamp(renderScale + SCALE_STEP, SCALE_MIN, SCALE_MAX);
    await rerenderPdfKeepingPosition();
  };

  document.getElementById("zoomOut").onclick = async () => {
    if (!allowed || isRendering) return;
    renderScale = clamp(renderScale - SCALE_STEP, SCALE_MIN, SCALE_MAX);
    await rerenderPdfKeepingPosition();
  };

  // ====== ä¸»æµç¨‹ ======
  async function initApp() {
    // é¿å…é‡è¤‡ init
    if (pdfDoc) return;

    showLoading(true);
    try {
      await loadPDF();
      // åˆæ¬¡æ¸²æŸ“
      await renderAllPdfPages();
      // ç¢ºä¿åˆå§‹åœ¨å°é¢
      currentPage = 0;
      restoreFlipStateAfterRerender();
      attachFlipEvents();
    } catch (err) {
      console.error(err);
      alert("PDF è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª book.pdf èˆ‡ index.html åœ¨åŒè³‡æ–™å¤¾ï¼Œä¸”ä½¿ç”¨ http server é–‹å•Ÿã€‚");
    } finally {
      showLoading(false);
    }
  }

  // å…¥å£ï¼šå…ˆåš 18+ ç¢ºèª
  checkAgeGate();
</script>
</body>
</html>
