<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>PDF ç¿»é é›»å­æ›¸ï¼ˆå¿«é€Ÿæ‡¶åŠ è¼‰ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

<style>
  html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#f0f0f0; font-family:"Noto Sans TC", sans-serif; }
  body.dark { background:#111; }
  body.dark #progressBar { background:#555; }
  body.dark #progressValue { background:#00d2ff; }
  body.dark .control-btn { background: rgba(60,60,60,.72); color:#fff; }
  body.dark #loading { color:#bbb; }
  body.dark .modal { background: rgba(40,40,40,.92); color:#fff; }
  body.dark .btn-no { background: rgba(255,255,255,.12); color:#fff; }

  .book { width:100vw; height:100vh; position:relative; perspective:2000px; overflow:hidden; }
  .page {
    width:100%; height:100%;
    position:absolute; top:0; left:0;
    background:#fff;
    transform-origin:left center;
    transition:transform .6s ease;
    box-shadow:0 0 15px rgba(0,0,0,.25);
    display:flex; justify-content:center; align-items:center;
    overflow:hidden;
  }
  .page.flipped { transform: rotateY(-180deg); z-index:1 !important; }

  .cover { background:#000; }
  .cover img { width:100%; height:100%; object-fit:cover; display:block; }

  .pdf-canvas { max-width:100%; max-height:100%; width:auto; height:auto; display:block; }

  /* æœªæ¸²æŸ“å ä½ */
  .placeholder {
    width: 100%;
    height: 100%;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#777;
    font-size:14px;
    padding:20px;
    text-align:center;
  }

  #progressBar { position:absolute; top:0; left:0; height:5px; width:100%; background:#ccc; z-index:999; }
  #progressValue { height:100%; width:0%; background:#4aa3ff; transition: width .25s ease; }

  .controls { position:absolute; top:10px; right:10px; display:flex; gap:10px; z-index:999; }
  .control-btn {
    background: rgba(255,255,255,.72);
    padding:8px 12px;
    border-radius:8px;
    font-size:16px;
    cursor:pointer;
    user-select:none;
    backdrop-filter: blur(4px);
    -webkit-tap-highlight-color: transparent;
  }

  #loading {
    position:absolute; inset:0;
    display:none;
    justify-content:center; align-items:center;
    font-size:16px; color:#666;
    z-index:998;
    pointer-events:none;
  }

  /* 18+ modal */
  .modal-backdrop { position:absolute; inset:0; background:rgba(0,0,0,.55); display:flex; justify-content:center; align-items:center; z-index:5000; padding:20px; }
  .modal { width:min(420px,100%); background:rgba(255,255,255,.92); border-radius:16px; padding:18px 16px; box-shadow:0 10px 30px rgba(0,0,0,.25); backdrop-filter: blur(8px); }
  .modal h3 { margin:0 0 8px; font-size:18px; }
  .modal p { margin:0 0 14px; font-size:14px; line-height:1.6; opacity:.9; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; }
  .btn { border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px; user-select:none; }
  .btn-yes { background:#4aa3ff; color:#fff; }
  .btn-no { background: rgba(0,0,0,.08); }

  .blocked { position:absolute; inset:0; z-index:4000; display:none; justify-content:center; align-items:center; background:#111; color:#fff; text-align:center; padding:20px; }
  .blocked .box { max-width:520px; background:rgba(255,255,255,.08); border-radius:16px; padding:18px 16px; line-height:1.7; }
</style>
</head>

<body>
  <div id="progressBar"><div id="progressValue"></div></div>

  <div class="controls">
    <div class="control-btn" id="zoomOut">Aâ€“</div>
    <div class="control-btn" id="zoomIn">A+</div>
    <div class="control-btn" id="modeToggle">ğŸŒ™</div>
  </div>

  <div class="book" id="book"></div>
  <div id="loading">æ¸²æŸ“ä¸­â€¦</div>

  <div id="ageModalRoot"></div>
  <div class="blocked" id="blocked">
    <div class="box">
      <div style="font-size:18px; margin-bottom:6px;">ç„¡æ³•é€²å…¥</div>
      <div style="opacity:.9; font-size:14px;">
        æœ¬å…§å®¹åƒ…é™å¹´æ»¿ 18 æ­²è€…ç€è¦½ã€‚<br>
        è‹¥ä½ å·²å¹´æ»¿ 18 æ­²ï¼Œè«‹é‡æ–°æ•´ç†ä¸¦é¸æ“‡ã€ŒYesã€ã€‚
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
  // ====== è¨­å®š ======
  const PDF_URL = "èªªé»å…”èµ¤-ä¾†éƒ½ä¾†äº†.pdf";
  const COVER_URL = "cover.png";

  let renderScale = 1.6;
  const SCALE_MIN = 0.8, SCALE_MAX = 2.6, SCALE_STEP = 0.2;

  // æ¸²æŸ“ç­–ç•¥ï¼šåªç¶­æŒã€Œç•¶å‰é å‰å¾Œå„ 1 é ã€å·²æ¸²æŸ“
  const PREFETCH_RADIUS = 1;

  // ====== ç‹€æ…‹ ======
  const book = document.getElementById("book");
  const loading = document.getElementById("loading");
  const blocked = document.getElementById("blocked");
  let allowed = false;

  let pdfDoc = null;
  let totalPdfPages = 0;

  // currentIndexï¼šåŒ…å«å°é¢
  // 0 = å°é¢ï¼›1..N = PDF ç¬¬ 1..N é 
  let currentIndex = 0;

  // pagesDom[0] = å°é¢ï¼›pagesDom[i] = PDF ç¬¬ i é ï¼ˆi>=1ï¼‰
  let pagesDom = [];
  // rendered[i] è¡¨ç¤º PDF ç¬¬ i é ï¼ˆi>=1ï¼‰æ˜¯å¦å·²æ¸²æŸ“
  let rendered = [];
  // é¿å…åŒé é‡è¤‡æ¸²æŸ“
  let renderingSet = new Set();

  function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
  function showLoading(show) { loading.style.display = show ? "flex" : "none"; }

  function updateProgress() {
    const totalWithoutCover = Math.max(1, pagesDom.length - 1);
    const percent = (currentIndex / totalWithoutCover) * 100;
    document.getElementById("progressValue").style.width = clamp(percent, 0, 100) + "%";
  }

  // ====== 18+ gate ======
  function showAgeModal() {
    const root = document.getElementById("ageModalRoot");
    root.innerHTML = `
      <div class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true">
          <h3>å…§å®¹å¹´é½¡ç¢ºèª</h3>
          <p>è«‹ç¢ºèªä½ æ˜¯å¦å·²å¹´æ»¿ <b>18 æ­²</b>ã€‚</p>
          <div class="modal-actions">
            <button class="btn btn-no" id="ageNo">No</button>
            <button class="btn btn-yes" id="ageYes">Yes</button>
          </div>
        </div>
      </div>
    `;
    document.getElementById("ageYes").onclick = () => {
      localStorage.setItem("age_verified_18", "yes");
      root.innerHTML = "";
      allowed = true;
      initApp();
    };
    document.getElementById("ageNo").onclick = () => {
      root.innerHTML = "";
      allowed = false;
      blocked.style.display = "flex";
    };
  }

  function checkAgeGate() {
    const v = localStorage.getItem("age_verified_18");
    if (v === "yes") { allowed = true; initApp(); }
    else showAgeModal();
  }

  // ====== PDF.js ======
  async function loadPDF() {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    pdfDoc = await pdfjsLib.getDocument(PDF_URL).promise;
    totalPdfPages = pdfDoc.numPages;
  }

  function makeCover() {
    const cover = document.createElement("div");
    cover.className = "page cover";
    cover.style.zIndex = 999999;
    cover.innerHTML = `<img src="${COVER_URL}" alt="å°é¢">`;
    return cover;
  }

  function makePdfPlaceholder(pageNum) {
    const wrap = document.createElement("div");
    wrap.className = "page";
    wrap.innerHTML = `<div class="placeholder">PDF ç¬¬ ${pageNum} é å°šæœªæ¸²æŸ“ï¼Œç¿»åˆ°é€™é æœƒè‡ªå‹•è¼‰å…¥ã€‚</div>`;
    return wrap;
  }

  function buildPageStack() {
    book.innerHTML = "";
    pagesDom = [];
    rendered = new Array(totalPdfPages + 1).fill(false);

    // 0:å°é¢
    const cover = makeCover();
    pagesDom[0] = cover;
    book.appendChild(cover);

    // 1..N:PDF placeholder
    for (let i = 1; i <= totalPdfPages; i++) {
      const pageWrap = makePdfPlaceholder(i);
      // z-indexï¼šè¶Šå‰é¢è¶Šå¤§ï¼ˆå°é¢æœ€é«˜ï¼‰
      pageWrap.style.zIndex = (totalPdfPages - i + 1);
      pagesDom[i] = pageWrap;
      book.appendChild(pageWrap);
    }

    // åˆå§‹åœ¨å°é¢
    currentIndex = 0;
    applyFlipState();
    updateProgress();
  }

  function applyFlipState() {
    for (let i = 0; i < pagesDom.length; i++) {
      if (i < currentIndex) pagesDom[i].classList.add("flipped");
      else pagesDom[i].classList.remove("flipped");
    }
  }

  async function renderPdfPage(pageNum) {
    if (pageNum < 1 || pageNum > totalPdfPages) return;
    if (rendered[pageNum]) return;
    if (renderingSet.has(pageNum)) return;

    renderingSet.add(pageNum);
    showLoading(true);

    try {
      const pdfPage = await pdfDoc.getPage(pageNum);
      const viewport = pdfPage.getViewport({ scale: renderScale });

      const canvas = document.createElement("canvas");
      canvas.className = "pdf-canvas";
      const ctx = canvas.getContext("2d");

      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      await pdfPage.render({ canvasContext: ctx, viewport }).promise;

      // æ”¾é€²è©²é å®¹å™¨ï¼Œæ›¿æ› placeholder
      const wrap = pagesDom[pageNum];
      wrap.innerHTML = "";
      wrap.appendChild(canvas);

      rendered[pageNum] = true;
    } finally {
      renderingSet.delete(pageNum);
      // å¦‚æœé‚„æœ‰å…¶ä»–é åœ¨æ¸²æŸ“ï¼Œå°±ä¸è¦é—œ
      if (renderingSet.size === 0) showLoading(false);
    }
  }

  async function ensureNearbyRendered() {
    // currentIndex=0 æ˜¯å°é¢ï¼Œå°æ‡‰ PDF ä¸éœ€è¦æ¸²æŸ“
    const center = currentIndex; // 1..N
    const tasks = [];

    for (let i = center - PREFETCH_RADIUS; i <= center + PREFETCH_RADIUS; i++) {
      if (i >= 1 && i <= totalPdfPages) tasks.push(renderPdfPage(i));
    }
    await Promise.all(tasks);
  }

  // ç¸®æ”¾ï¼šåªé‡ç¹ªã€Œé™„è¿‘é ã€å³å¯ï¼ˆä¸é‡ç¹ªæ•´æœ¬ï¼‰
  async function rerenderNearby() {
    // å°‡é™„è¿‘é è¨­ç‚ºæœªæ¸²æŸ“ä¸¦æ¢å¾© placeholderï¼Œå†æ¸²æŸ“
    const center = currentIndex;
    for (let i = center - PREFETCH_RADIUS; i <= center + PREFETCH_RADIUS; i++) {
      if (i >= 1 && i <= totalPdfPages) {
        rendered[i] = false;
        pagesDom[i].innerHTML = `<div class="placeholder">é‡æ–°æ¸²æŸ“ PDF ç¬¬ ${i} é â€¦</div>`;
      }
    }
    await ensureNearbyRendered();
  }

  // ====== æ‰‹å‹¢ç¿»é  ======
  function attachFlipEvents() {
    let startX = 0;

    document.addEventListener("touchstart", e => {
      if (!allowed) return;
      startX = e.touches[0].clientX;
    }, { passive: true });

    document.addEventListener("touchend", async e => {
      if (!allowed) return;
      const endX = e.changedTouches[0].clientX;
      const diff = endX - startX;

      if (Math.abs(diff) < 40) return;

      // å·¦æ»‘ä¸‹ä¸€é 
      if (diff < 0 && currentIndex < pagesDom.length - 1) {
        pagesDom[currentIndex].classList.add("flipped");
        currentIndex++;
        updateProgress();

        // ç¿»åˆ° PDF é å°±æ¸²æŸ“ä¸¦é æŠ“é™„è¿‘é 
        if (currentIndex >= 1) await ensureNearbyRendered();
      }
      // å³æ»‘ä¸Šä¸€é 
      else if (diff > 0 && currentIndex > 0) {
        currentIndex--;
        pagesDom[currentIndex].classList.remove("flipped");
        updateProgress();

        if (currentIndex >= 1) await ensureNearbyRendered();
      }
    }, { passive: true });
  }

  // ====== æ§åˆ¶ ======
  document.getElementById("modeToggle").onclick = () => {
    document.body.classList.toggle("dark");
    document.getElementById("modeToggle").textContent =
      document.body.classList.contains("dark") ? "â˜€ï¸" : "ğŸŒ™";
  };

  document.getElementById("zoomIn").onclick = async () => {
    if (!allowed) return;
    renderScale = clamp(renderScale + SCALE_STEP, SCALE_MIN, SCALE_MAX);
    if (currentIndex >= 1) await rerenderNearby();
  };

  document.getElementById("zoomOut").onclick = async () => {
    if (!allowed) return;
    renderScale = clamp(renderScale - SCALE_STEP, SCALE_MIN, SCALE_MAX);
    if (currentIndex >= 1) await rerenderNearby();
  };

  // ====== ä¸»æµç¨‹ ======
  async function initApp() {
    try {
      showLoading(true);
      await loadPDF();
      buildPageStack();

      attachFlipEvents();

      // åˆæ¬¡åªæ¸²æŸ“ã€Œç¬¬ 1 é ã€è®“ä½ ä¸€ç¿»å°é¢å°±ç§’å‡ºç¾
      await renderPdfPage(1);
      showLoading(false);
    } catch (err) {
      console.error(err);
      alert("PDF è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª book.pdf èˆ‡ index.html åŒè³‡æ–™å¤¾ï¼Œä¸¦ä½¿ç”¨ http server é–‹å•Ÿã€‚");
      showLoading(false);
    }
  }

  checkAgeGate();
</script>
</body>
</html>
