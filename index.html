<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>說點兔赤-來都來了</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  background: #f0f0f0;
  font-family: "Noto Sans TC", sans-serif;
}

/* 書本容器 */
.book {
  width: 100vw;
  height: 100vh;
  position: relative;
  perspective: 2000px;
  overflow: hidden;
}

/* 外層 page：只負責翻頁 */
.page {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0; left: 0;
  background: #fff;
  transform-origin: left center;
  transition: transform 0.6s ease;
  box-shadow: 0 0 15px rgba(0,0,0,0.25);
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
}

.page.flipped {
  transform: rotateY(-180deg);
  z-index: 1 !important;
}

/* 內層：專門做「置中 + 整頁放大」 */
.page-inner {
  display: flex;
  justify-content: center;
  align-items: center;
  transform: scale(1.4);          /* ⭐ 整頁放大倍率 */
  transform-origin: center center;
}

/* 封面 */
.cover {
  padding: 0;
  background: #000;
}
.cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* PDF Canvas */
.pdf-canvas {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  display: block;
}

/* 低清 → 高清淡入 */
.fade-in {
  animation: fadeIn 160ms ease-out;
}
@keyframes fadeIn {
  from { opacity: 0.4; }
  to   { opacity: 1; }
}

/* Placeholder */
.placeholder {
  font-size: 14px;
  color: #777;
}

/* 進度條 */
#progressBar {
  position: absolute;
  top: 0; left: 0;
  height: 5px;
  width: 100%;
  background: #ccc;
  z-index: 999;
}
#progressValue {
  height: 100%;
  width: 0%;
  background: #4aa3ff;
  transition: width 0.25s ease;
}

/* 載入提示 */
#hint {
  position: absolute;
  right: 12px;
  bottom: 10px;
  font-size: 12px;
  color: rgba(0,0,0,0.55);
  z-index: 999;
  pointer-events: none;
  display: none;
}

/* 18+ Modal */
.modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 5000;
}
.modal {
  background: rgba(255,255,255,0.95);
  border-radius: 16px;
  padding: 18px 16px;
  width: min(420px, 90%);
}
.modal h3 { margin: 0 0 8px; }
.modal p { font-size: 14px; line-height: 1.6; }
.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.btn {
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  cursor: pointer;
}
.btn-yes { background: #4aa3ff; color: #fff; }
.btn-no  { background: #ddd; }

/* 未滿18阻擋 */
.blocked {
  position: absolute;
  inset: 0;
  background: #111;
  color: #fff;
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 4000;
}
.blocked .box {
  background: rgba(255,255,255,0.1);
  padding: 20px;
  border-radius: 16px;
  text-align: center;
}
</style>
</head>

<body>

<div id="progressBar"><div id="progressValue"></div></div>
<div class="book" id="book"></div>
<div id="hint">載入中…</div>

<div id="ageModalRoot"></div>
<div class="blocked" id="blocked">
  <div class="box">
    本內容僅限年滿 18 歲者瀏覽
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
const PDF_URL   = "說點兔赤-來都來了.pdf";
const COVER_URL = "cover.png";

const LOW_SCALE  = 0.9;
const HIGH_SCALE = 1.5;
const UPGRADE_DELAY = 250;
const PREFETCH_RADIUS = 1;

const book = document.getElementById("book");
const hint = document.getElementById("hint");
const blocked = document.getElementById("blocked");

let allowed = false;
let pdfDoc = null;
let totalPages = 0;
let currentIndex = 0;
let pagesDom = [];
let quality = [];
let timers = [];

function updateProgress() {
  const total = Math.max(1, pagesDom.length - 1);
  document.getElementById("progressValue").style.width =
    (currentIndex / total) * 100 + "%";
}

/* 18+ gate */
function showAgeModal() {
  const root = document.getElementById("ageModalRoot");
  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>年齡確認</h3>
        <p>你是否已年滿 18 歲？</p>
        <div class="modal-actions">
          <button class="btn btn-no" id="no">No</button>
          <button class="btn btn-yes" id="yes">Yes</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById("yes").onclick = () => {
    localStorage.setItem("age_verified_18", "yes");
    root.innerHTML = "";
    allowed = true;
    init();
  };
  document.getElementById("no").onclick = () => {
    root.innerHTML = "";
    blocked.style.display = "flex";
  };
}

function checkAge() {
  if (localStorage.getItem("age_verified_18") === "yes") {
    allowed = true;
    init();
  } else showAgeModal();
}

/* PDF */
async function loadPDF() {
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  pdfDoc = await pdfjsLib.getDocument(PDF_URL).promise;
  totalPages = pdfDoc.numPages;
}

function makeCover() {
  const p = document.createElement("div");
  p.className = "page cover";
  p.style.zIndex = 9999;
  p.innerHTML = `<img src="${COVER_URL}">`;
  return p;
}

function makePlaceholder(n) {
  const p = document.createElement("div");
  p.className = "page";
  p.innerHTML = `<div class="placeholder">PDF 第 ${n} 頁</div>`;
  return p;
}

function buildPages() {
  book.innerHTML = "";
  pagesDom = [];
  quality = new Array(totalPages + 1).fill(0);
  timers = [];

  pagesDom[0] = makeCover();
  book.appendChild(pagesDom[0]);

  for (let i = 1; i <= totalPages; i++) {
    pagesDom[i] = makePlaceholder(i);
    pagesDom[i].style.zIndex = totalPages - i;
    book.appendChild(pagesDom[i]);
  }
}

function applyFlip() {
  pagesDom.forEach((p, i) =>
    p.classList.toggle("flipped", i < currentIndex)
  );
}

async function renderPage(n, scale, q) {
  if (quality[n] >= q) return;
  hint.style.display = "block";

  const pdfPage = await pdfDoc.getPage(n);
  const viewport = pdfPage.getViewport({ scale });

  const canvas = document.createElement("canvas");
  canvas.className = "pdf-canvas fade-in";
  canvas.width = viewport.width;
  canvas.height = viewport.height;

  await pdfPage.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;

  const inner = document.createElement("div");
  inner.className = "page-inner";
  inner.appendChild(canvas);

  pagesDom[n].innerHTML = "";
  pagesDom[n].appendChild(inner);
  quality[n] = q;

  if (q === 1) {
    clearTimeout(timers[n]);
    timers[n] = setTimeout(() => {
      if (Math.abs(n - currentIndex) <= PREFETCH_RADIUS)
        renderPage(n, HIGH_SCALE, 2);
    }, UPGRADE_DELAY);
  }

  hint.style.display = "none";
}

async function ensureNearby() {
  for (let i = currentIndex - PREFETCH_RADIUS; i <= currentIndex + PREFETCH_RADIUS; i++) {
    if (i >= 1 && i <= totalPages) {
      if (quality[i] === 0) await renderPage(i, LOW_SCALE, 1);
    }
  }
}

/* 翻頁 */
function attachFlip() {
  let sx = 0;
  document.addEventListener("touchstart", e => sx = e.touches[0].clientX, { passive: true });
  document.addEventListener("touchend", async e => {
    const dx = e.changedTouches[0].clientX - sx;
    if (Math.abs(dx) < 40) return;

    if (dx < 0 && currentIndex < pagesDom.length - 1) currentIndex++;
    else if (dx > 0 && currentIndex > 0) currentIndex--;

    applyFlip();
    updateProgress();
    if (currentIndex >= 1) await ensureNearby();
  }, { passive: true });
}

/* init */
async function init() {
  await loadPDF();
  buildPages();
  attachFlip();
  await renderPage(1, LOW_SCALE, 1);
  updateProgress();
}

checkAge();
</script>

</body>
</html>

